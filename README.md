# Description

These docker images are based on the official openjdk docker images on top of Alpine. The purpose of these images is to trim them by only including the required Java Modules in order to make the docker images as small as possible (for Java applications running on the Java Platform Module System).

# Quick reference

Maintained by:  Sid Med (sid.med@lhih.net)

Github project:  https://github.com/sid-hbm/JPMS

# How to use this image

##  Using Spring-Boot Application:

If you are using a **Spring-Boot application** (**spring version < 6**) and you want to have the smallest docker image possible (based on **Alpine** and having a custom java runtime image using only the necessary java modules required by spring framework), then you can have a **Dockerfile** in the root directory of your application as follows:

    FROM  sidhm/jpms:18-spring5  AS  builder

    RUN mkdir /app
    WORKDIR app
    COPY build/libs/*.jar .
    RUN rm *plain*.jar
    RUN java -Djarmode=layertools -jar *.jar extract

    FROM  sidhm/jpms:18-spring5

    RUN mkdir /app
    WORKDIR app
    COPY --from=builder /app/spring-boot-loader/ ./
    COPY --from=builder /app/dependencies/ ./
    COPY --from=builder /app/snapshot-dependencies/ ./
    COPY --from=builder /app/application/ ./
    EXPOSE 8080
    ENTRYPOINT ["java", "org.springframework.boot.loader.JarLauncher"]

##  Using Jib gradle plugin to create the docker image for your application:

If you are using **Jib plugin** in your project (in a **Spring-Boot** application with **spring framework version < 6**) and you want to have the smallest docker image generated by **Jib plugin**, then just set the from image attribute in your **build.gradle** file as follows:

     jib.from.image = 'sidhm/jpms:18-spring5'

# Other Use Cases

**Springframework version < 6** is using many unnecessary java modules (such as **java.desktop** to name a few). The exact the list of Java Modules required by a **Spring-Boot** application running in the **Java Platform Module System** (for **springframework version < 6**) is the following:

    - java.base
    - java.logging,
    - java.management,
    - java.security.jgss 
    - java.naming
    - java.instrument,
    - java.desktop
    - jdk.unsupported

The docker image **sidhm/jpms:18-spring5** provides the above Java Modules and it would make your **Spring-Boot** docker image around **95 MB** of size (not more than that). **Springframework version >= 6**  (and **Spring-Boot version >= 3**) will not have dependency on many of the above unnecessary Java Module and when **Spring-Boot version >= 3** is out, we can have a much smaller docker image for it.

If you are not using Spring-Boot, just determine what Java Modules your application needs and then use the proper docker image that contains only those Java Modules required by your application. There are many tags in this repository. The tag starts with the version of Java (16, 17, 18, or 19) and then what java module to be included in the custom java runtime image inside of the docker image. For example:

- sidhm/jpms:18-sql      (this docker image uses Java version 18 and the custom java runtime image only includes two java modules: java.base and java.sql)
- sidhm/jpms:18-logging      (this docker image uses Java version 18 and the custom java runtime image only includes two java modules: java.base and java.logging)
- etc...

# Running a Spring-Boot application on the Java Platform Module System

Use this gradle plugin [org.javamodularity.moduleplugin](https://github.com/java9-modularity/gradle-modules-plugin)

build.gradle file will declare the plugin as follows:

    plugins {
       id 'org.javamodularity.moduleplugin' version '1.8.10' apply false
    }

Under the folder **src/main/java**, create a file called **module-info.java** which would contain at least the following:

    module name.of.your.module {
       requires spring.web;
       requires spring.boot;
       requires spring.boot.autoconfigure;
       requires spring.beans;
       requires spring.context;
       requires spring.messaging;
       requires com.fasterxml.jackson.databind;
       requires org.apache.logging.log4j;

       opens your.data.package to spring.core;
       opens your.config.package to spring.core;

       exports your.data.package to spring.beans, spring.context;
       exports your.config.package to spring.beans, spring.context;
       exports your.data.package to com.fasterxml.jackson.databind;
    }

- In the above, replace **"name.of.your.module"** with the name you will give your module (usually the artifact name with dots instead of dashes. If your artifact is called **"hello-world"**, then the name of your module would become **"hello.world"**)

- replace **"your.data.package"** with the package name that contains your data model

- replace **"your.config.package"** with the package name that contains your spring beans configurations (classes annotated with **@Configuration**). 
